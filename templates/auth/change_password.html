{% extends "auth/base.html" %}

{% block content %}
<div class="login-container">
    <div class="login-card">
        <h2>Change Password</h2>
        <p class="subtitle">Update your account password</p>

        {% if error %}
            <div class="error-message">{{ error }}</div>
        {% endif %}

        <form id="changePasswordForm" class="profile-form">
            <div class="form-group">
                <label class="form-label">Current Password</label>
                <input type="password" 
                       class="form-control" 
                       name="current_password"
                       placeholder="Enter current password"
                       required>
            </div>

            <div class="form-group">
                <label class="form-label">New Password</label>
                <input type="password" 
                       class="form-control" 
                       id="newPassword"
                       name="new_password"
                       placeholder="Enter new password"
                       required>
                <span class="field-description">Must be at least 8 characters long</span>
                <div id="passwordStrength" class="password-strength"></div>
            </div>

            <div class="form-group">
                <label class="form-label">Confirm New Password</label>
                <input type="password" 
                       class="form-control" 
                       id="confirmPassword"
                       name="confirm_password"
                       placeholder="Confirm new password"
                       required>
                <div id="passwordMatch" class="password-match"></div>
            </div>

            <button type="submit" class="login-btn" id="submitBtn" disabled>Update Password</button>
        </form>

        <div class="navigation-links">
            <a href="/auth/profile" class="back-link">Back to Profile</a>
        </div>
    </div>
</div>

<script>
const newPasswordInput = document.getElementById('newPassword');
const confirmPasswordInput = document.getElementById('confirmPassword');
const passwordStrengthDiv = document.getElementById('passwordStrength');
const passwordMatchDiv = document.getElementById('passwordMatch');
const submitBtn = document.getElementById('submitBtn');

function checkPasswordStrength(password) {
    let strength = 0;
    
    // Length check
    if (password.length >= 8) strength += 1;
    
    // Contains number
    if (/\d/.test(password)) strength += 1;
    
    // Contains letter
    if (/[a-zA-Z]/.test(password)) strength += 1;
    
    // Contains special character
    if (/[^A-Za-z0-9]/.test(password)) strength += 1;

    switch(strength) {
        case 0:
        case 1:
            passwordStrengthDiv.textContent = 'Weak password';
            passwordStrengthDiv.className = 'password-strength weak';
            break;
        case 2:
            passwordStrengthDiv.textContent = 'Medium password';
            passwordStrengthDiv.className = 'password-strength medium';
            break;
        case 3:
            passwordStrengthDiv.textContent = 'Strong password';
            passwordStrengthDiv.className = 'password-strength strong';
            break;
        case 4:
            passwordStrengthDiv.textContent = 'Very strong password';
            passwordStrengthDiv.className = 'password-strength very-strong';
            break;
    }
    
    return strength > 1; // Return true if password is at least medium strength
}

function checkPasswordsMatch() {
    const newPassword = newPasswordInput.value;
    const confirmPassword = confirmPasswordInput.value;
    
    if (confirmPassword === '') {
        passwordMatchDiv.textContent = '';
        passwordMatchDiv.className = 'password-match';
        return false;
    }
    
    if (newPassword === confirmPassword) {
        passwordMatchDiv.textContent = 'Passwords match';
        passwordMatchDiv.className = 'password-match match';
        return true;
    } else {
        passwordMatchDiv.textContent = 'Passwords do not match';
        passwordMatchDiv.className = 'password-match no-match';
        return false;
    }
}

function validateForm() {
    const isStrengthOk = checkPasswordStrength(newPasswordInput.value);
    const isMatchOk = checkPasswordsMatch();
    submitBtn.disabled = !(isStrengthOk && isMatchOk);
}

newPasswordInput.addEventListener('input', () => {
    checkPasswordStrength(newPasswordInput.value);
    validateForm();
});

confirmPasswordInput.addEventListener('input', () => {
    checkPasswordsMatch();
    validateForm();
});

document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    
    try {
        const response = await fetch('/auth/change-password', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        if (result.success) {
            alert(result.message);
            window.location.href = '/auth/profile';
        } else {
            alert(result.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error updating password');
    }
});
</script>

<style>
.password-strength, .password-match {
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

.password-strength.weak {
    color: #dc2626;
}

.password-strength.medium {
    color: #d97706;
}

.password-strength.strong {
    color: #059669;
}

.password-strength.very-strong {
    color: #047857;
}

.password-match.match {
    color: #059669;
}

.password-match.no-match {
    color: #dc2626;
}

.login-btn:disabled {
    background-color: #9ca3af;
    cursor: not-allowed;
}
</style>
{% endblock %} 